import { Router } from "express";
import { db } from "../../lib/db";

const router = Router();
const USER_ID = "demo-user";

// Types toevoegen zodat TS weet welke velden bestaan
type ReceiptRow = {
  id: number;
  status: string;
  transaction_id: number | null;
};

type TransactionRow = {
  id: number;
  receipt_id: number | null;
};

// ------------------------------------------------------------
// POST /receipts/:id/link
// → bon koppelen aan bestaande transactie + archiveren
// ------------------------------------------------------------
router.post("/:id/link", (req, res) => {
  const receiptId = Number(req.params.id);
  const { transactionId } = req.body;

  if (!transactionId) {
    return res.status(400).json({ error: "transactionId is required" });
  }

  // 1. Bestaat de bon?
  const receipt = db
    .prepare(
      `SELECT id, status, transaction_id 
       FROM receipts 
       WHERE id = ? AND user_id = ?`
    )
    .get(receiptId, USER_ID) as ReceiptRow | undefined;

  if (!receipt) {
    return res.status(404).json({ error: "Receipt not found" });
  }

  // 2. Bestaat de transactie?
  const transaction = db
    .prepare(
      `SELECT id, receipt_id 
       FROM transactions 
       WHERE id = ? AND user_id = ?`
    )
    .get(transactionId, USER_ID) as TransactionRow | undefined;

  if (!transaction) {
    return res.status(404).json({ error: "Transaction not found" });
  }

  // 3. Als de transactie al gekoppeld is aan een andere bon → fout
  if (transaction.receipt_id && transaction.receipt_id !== receiptId) {
    return res.status(400).json({
      error: "Transaction is already linked to another receipt",
    });
  }

  // 4. Als de bon al gekoppeld is → fout
  if (receipt.transaction_id && receipt.transaction_id !== transactionId) {
    return res.status(400).json({
      error: "Receipt is already linked to another transaction",
    });
  }

  // 5. Koppel transactie aan bon
  db.prepare(
    `UPDATE transactions
     SET receipt_id = ?
     WHERE id = ? AND user_id = ?`
  ).run(receiptId, transactionId, USER_ID);

  // 6. Archiveer bon + zet status correct
  db.prepare(
    `UPDATE receipts
     SET status = 'archived', transaction_id = ?
     WHERE id = ? AND user_id = ?`
  ).run(transactionId, receiptId, USER_ID);

  return res.json({
    success: true,
    message: "Receipt linked and archived",
    transactionId,
    receiptId,
  });
});

// ------------------------------------------------------------
// POST /receipts/:id/create-transaction
// → nieuwe transactie aanmaken + bon koppelen + archiveren
// ------------------------------------------------------------
router.post("/:id/create-transaction", (req, res) => {
  const receiptId = req.params.id;
  const { description, amount, date, merchant, category_id } = req.body;

  if (!amount || !date) {
    return res.status(400).json({
      error: "amount and date are required to create a transaction",
    });
  }

  const receipt = db
    .prepare("SELECT id FROM receipts WHERE id = ? AND user_id = ?")
    .get(receiptId, USER_ID) as { id: number } | undefined;

  if (!receipt) {
    return res.status(404).json({ error: "Receipt not found" });
  }

  const stmt = db.prepare(
    `
    INSERT INTO transactions (description, amount, date, merchant, category_id, user_id, receipt_id)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `
  );

  const result = stmt.run(
    description || merchant || "Onbekende transactie",
    amount,
    date,
    merchant || null,
    category_id || null,
    USER_ID,
    receiptId
  );

  const newTransactionId = result.lastInsertRowid;

  db.prepare(
    `
    UPDATE receipts
    SET status = 'archived', transaction_id = ?
    WHERE id = ? AND user_id = ?
  `
  ).run(newTransactionId, receiptId, USER_ID);

  res.json({
    success: true,
    message: "New transaction created, receipt linked and archived",
    transactionId: newTransactionId,
    receiptId,
  });
});

// ------------------------------------------------------------
// POST /receipts/:id/auto-link
// → AI-result → transactie aanmaken → koppelen → archiveren
// ------------------------------------------------------------
router.post("/:id/auto-link", (req, res) => {
  const receiptId = Number(req.params.id);

  const receipt = db
    .prepare("SELECT * FROM receipts WHERE id = ? AND user_id = ?")
    .get(receiptId, USER_ID) as
    | {
        id: number;
        aiResult: string | null;
        user_id: string;
        status: string;
        transaction_id: number | null;
      }
    | undefined;

  if (!receipt) {
    return res.status(404).json({ error: "Receipt not found" });
  }

  if (!receipt.aiResult) {
    return res.status(400).json({ error: "Receipt has no AI result" });
  }

  const data = JSON.parse(receipt.aiResult);

  const insertTx = db.prepare(
    `
    INSERT INTO transactions (
      amount,
      date,
      transaction_date,
      merchant,
      description,
      category_id,
      subcategory,
      user_id,
      receipt_id
    )
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
  `
  );

  const info = insertTx.run(
    -Math.abs(data.total),
    data.date.split("T")[0],
    data.date.split("T")[0],
    data.merchant,
    data.merchant,
    null,
    null,
    USER_ID,
    receiptId
  );

  const transactionId = info.lastInsertRowid;

  db.prepare(
    `
    UPDATE receipts
    SET transaction_id = ?, status = 'archived'
    WHERE id = ? AND user_id = ?
  `
  ).run(transactionId, receiptId, USER_ID);

  res.json({
    success: true,
    message: "Receipt auto-linked and archived",
    transactionId,
    receiptId,
  });
});

// ------------------------------------------------------------
// POST /category/confirm
// ------------------------------------------------------------
router.post("/category/confirm", (req, res) => {
  const { transactionId, category_id, merchant } = req.body;

  if (!transactionId || !category_id) {
    return res.status(400).json({
      error: "transactionId and category_id are required",
    });
  }

  db.prepare(
    `
    UPDATE transactions
    SET category_id = ?
    WHERE id = ? AND user_id = ?
  `
  ).run(category_id, transactionId, USER_ID);

  if (merchant) {
    db.prepare(
      `
      INSERT OR REPLACE INTO merchant_memory (merchant, category_id, user_id)
      VALUES (?, ?, ?)
    `
    ).run(merchant, category_id, USER_ID);
  }

  res.json({
    success: true,
    message: "Category confirmed and merchant memory updated",
    transactionId,
    category_id,
  });
});

export default router;
